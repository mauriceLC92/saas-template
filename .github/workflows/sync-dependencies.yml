name: Sync Dependencies from longhabit

on:
  schedule:
    # Runs every Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write       # Create branches and commits
  pull-requests: write  # Create pull requests

jobs:
  sync-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better git operations

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Check for existing sync PR
        id: check-pr
        run: |
          # Check if there's already an open PR with the sync label
          EXISTING_PR=$(gh pr list --label "dependencies,automated" --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "existing_pr=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Found existing PR #$EXISTING_PR"
          else
            echo "No existing PR found"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Sync dependencies from longhabit
        id: sync
        run: |
          chmod +x .github/scripts/sync-dependencies.sh
          .github/scripts/sync-dependencies.sh
        env:
          LONGHABIT_REPO: s-petr/longhabit
          LONGHABIT_BRANCH: main

      - name: Update Go dependencies
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          cd backend
          go mod tidy
          cd ..

      - name: Update NPM dependencies
        if: steps.sync.outputs.has_changes == 'true'
        run: |
          npm install

      - name: Create branch and commit changes
        if: steps.sync.outputs.has_changes == 'true'
        id: commit
        run: |
          BRANCH_NAME="sync/dependencies-$(date +%Y-%m-%d)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

          # Check if branch already exists and handle accordingly
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME exists, checking out and resetting..."
            git fetch origin
            git checkout "$BRANCH_NAME"
            git reset --hard origin/master
          else
            echo "Creating new branch $BRANCH_NAME..."
            git checkout -b "$BRANCH_NAME"
          fi

          # Stage all changes
          git add -A

          # Commit with detailed message
          git commit -m "chore: sync dependencies from longhabit

Automated dependency sync from upstream repository:
https://github.com/s-petr/longhabit

Files updated:
$(echo "${{ steps.sync.outputs.changed_files }}" | tr ',' '\n' | sed 's/^/- /')

This PR includes dependency updates for both Go backend and NPM frontend packages.
Lockfiles (go.sum, package-lock.json) have been automatically regenerated.

ü§ñ Generated by GitHub Actions"

          # Push branch
          git push origin "$BRANCH_NAME"

      - name: Generate PR description
        if: steps.sync.outputs.has_changes == 'true'
        id: pr-description
        run: |
          chmod +x .github/scripts/generate-pr-description.sh
          .github/scripts/generate-pr-description.sh "${{ steps.sync.outputs.changed_files }}"

      - name: Create Pull Request
        if: steps.sync.outputs.has_changes == 'true' && steps.check-pr.outputs.existing_pr == ''
        id: create-pr
        run: |
          PR_URL=$(gh pr create \
            --title "chore: sync dependencies from longhabit ($(date +%Y-%m-%d))" \
            --body-file .github/pr-description.md \
            --label "dependencies,automated" \
            --base master)

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Created PR: $PR_URL"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update existing Pull Request
        if: steps.sync.outputs.has_changes == 'true' && steps.check-pr.outputs.existing_pr != ''
        run: |
          gh pr edit ${{ steps.check-pr.outputs.existing_pr }} \
            --body-file .github/pr-description.md

          echo "‚úÖ Updated existing PR #${{ steps.check-pr.outputs.existing_pr }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Summary
        run: |
          if [ "${{ steps.sync.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Dependency sync completed successfully"
            echo "Changed files: ${{ steps.sync.outputs.changed_files }}"
            if [ -n "${{ steps.create-pr.outputs.pr_url }}" ]; then
              echo "PR created: ${{ steps.create-pr.outputs.pr_url }}"
            elif [ -n "${{ steps.check-pr.outputs.existing_pr }}" ]; then
              echo "Existing PR updated: #${{ steps.check-pr.outputs.existing_pr }}"
            fi
          else
            echo "‚ÑπÔ∏è No dependency changes detected - all files are in sync"
          fi
