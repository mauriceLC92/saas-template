name: Sync Dependencies from longhabit

on:
  schedule:
    # Runs on the 1st, 11th, and 21st of each month at 6 AM UTC (~every 10 days)
    - cron: "0 6 1,11,21 * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  sync-dependencies:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Clone upstream and gather context
        id: context
        run: |
          set -euo pipefail

          UPSTREAM_DIR="/tmp/longhabit"
          git clone --quiet https://github.com/s-petr/longhabit.git "$UPSTREAM_DIR"

          # Determine the last analyzed commit
          TRACKER_FILE=".github/last-sync-commit"
          if [ -f "$TRACKER_FILE" ] && [ -s "$TRACKER_FILE" ]; then
            LAST_SHA=$(cat "$TRACKER_FILE" | tr -d '[:space:]')
            echo "Last analyzed commit: $LAST_SHA"
          else
            # First run: analyze last 30 days
            LAST_SHA=$(git -C "$UPSTREAM_DIR" log --since="30 days ago" --format="%H" --reverse | head -1)
            if [ -z "$LAST_SHA" ]; then
              echo "No upstream commits in last 30 days"
              echo "has_new_commits=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            # Use the parent of the oldest commit so it's included in the range
            LAST_SHA=$(git -C "$UPSTREAM_DIR" rev-parse "${LAST_SHA}^" 2>/dev/null || echo "")
            if [ -z "$LAST_SHA" ]; then
              LAST_SHA=""
            fi
            echo "First run: analyzing last 30 days of commits"
          fi

          LATEST_SHA=$(git -C "$UPSTREAM_DIR" rev-parse HEAD)
          echo "latest_sha=$LATEST_SHA" >> "$GITHUB_OUTPUT"

          # Check if there are new commits
          if [ -n "$LAST_SHA" ] && [ "$LAST_SHA" = "$LATEST_SHA" ]; then
            echo "No new upstream commits since last sync"
            echo "has_new_commits=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_new_commits=true" >> "$GITHUB_OUTPUT"

          # Get commit log since last analyzed SHA
          if [ -n "$LAST_SHA" ]; then
            COMMIT_LOG=$(git -C "$UPSTREAM_DIR" log --oneline "${LAST_SHA}..HEAD" 2>/dev/null || git -C "$UPSTREAM_DIR" log --oneline -20)
            CHANGED_FILES=$(git -C "$UPSTREAM_DIR" diff --name-only "${LAST_SHA}..HEAD" 2>/dev/null || git -C "$UPSTREAM_DIR" diff --name-only HEAD~20..HEAD 2>/dev/null || echo "unable to determine")
          else
            COMMIT_LOG=$(git -C "$UPSTREAM_DIR" log --oneline -20)
            CHANGED_FILES=$(git -C "$UPSTREAM_DIR" diff --name-only HEAD~20..HEAD 2>/dev/null || echo "unable to determine")
          fi

          # Save context to files that Claude can read
          echo "$COMMIT_LOG" > /tmp/upstream-commits.txt
          echo "$CHANGED_FILES" > /tmp/upstream-changed-files.txt
          cp "$UPSTREAM_DIR/package.json" /tmp/upstream-package.json
          cp "$UPSTREAM_DIR/backend/go.mod" /tmp/upstream-go.mod

          echo "Upstream commits since last sync:"
          echo "$COMMIT_LOG"
          echo ""
          echo "Changed files:"
          echo "$CHANGED_FILES"

      - name: Apply dependency updates with Claude
        if: steps.context.outputs.has_new_commits == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          branch_name_template: "{{prefix}}sync/deps-{{timestamp}}"
          prompt: |
            You are a dependency sync bot. Your job is to compare upstream dependency files from the s-petr/longhabit repository with the local ones and apply ONLY overlapping version bumps.

            ## Instructions

            ### Step 1: Read all dependency files

            Read these upstream files (saved during context gathering):
            - `/tmp/upstream-package.json` — upstream NPM dependencies
            - `/tmp/upstream-go.mod` — upstream Go dependencies
            - `/tmp/upstream-commits.txt` — list of new upstream commits
            - `/tmp/upstream-changed-files.txt` — files changed in upstream

            Read these local files:
            - `package.json` — local NPM dependencies
            - `backend/go.mod` — local Go dependencies

            ### Step 2: Compare and apply ONLY overlapping dependency version bumps

            **Rules — you MUST follow these exactly:**

            1. **Only bump EXISTING packages** — if a package exists in upstream `package.json` or `go.mod` but NOT in the local file, DO NOT add it. Ignore it completely.
            2. **Only compare dependency version sections** — in `package.json`, only look at `dependencies`, `devDependencies`, `peerDependencies`, `optionalDependencies`, `overrides`, and `resolutions`. DO NOT touch `name`, `version`, `description`, `author`, `scripts`, `repository`, `homepage`, `license`, `type`, or any other non-dependency fields.
            3. **Preserve the Go module path** — the first line of `backend/go.mod` must remain `module github.com/mauriceLC92/saas-template`. Do NOT change it to the upstream module path.
            4. **Preserve Go version** — do not change the `go` directive version unless the upstream version is higher.
            5. **Only bump direct dependencies in go.mod** — look at the first `require (...)` block. Do NOT modify indirect dependencies (the second `require` block with `// indirect` comments). `go mod tidy` will handle those.
            6. **If a local package has a HIGHER version than upstream, keep the local version** — only bump when upstream is newer.

            ### Step 3: Regenerate lockfiles

            If you made changes to `package.json`, run: `npm install`
            If you made changes to `backend/go.mod`, run: `cd backend && go mod tidy`

            ### Step 4: Determine if a PR is needed

            - If NO dependency versions were changed (all local versions already match or are newer than upstream), output a message saying "No dependency changes needed — all versions are up to date." and DO NOT create any commits or PR.
            - If changes were made, commit them and the action will create a PR automatically.

            ### Step 5: PR description (only if changes were made)

            Use this format for the commit message: `chore: sync dependencies from longhabit`

            Use this exact format for the PR body:

            ## Dependency Sync from longhabit

            Automated dependency version sync from [s-petr/longhabit](https://github.com/s-petr/longhabit).

            ### NPM Dependency Changes

            | Package | Old Version | New Version | Section |
            |---------|-------------|-------------|---------|
            | (list each changed package) | (old) | (new) | dependencies/devDependencies |

            _(or "No NPM dependency changes" if none)_

            ### Go Dependency Changes

            | Module | Old Version | New Version |
            |--------|-------------|-------------|
            | (list each changed module) | (old) | (new) |

            _(or "No Go dependency changes" if none)_

            ### Other Upstream Changes (not applied)

            The following non-dependency files were also changed upstream but are NOT included in this PR (read /tmp/upstream-changed-files.txt for the full list):
            - (list files that are NOT package.json, package-lock.json, go.mod, or go.sum)

            Review the [upstream commits](https://github.com/s-petr/longhabit/commits/main) if you want to manually apply any of these changes.

            ### Testing Checklist

            - [ ] `npm run build:client` — frontend builds
            - [ ] `npm run build:server` — backend builds
            - [ ] `npm run lint` — type checking and linting pass
            - [ ] `npm run dev` — dev servers start without errors

            ### Important Reminders
            - Do NOT add new packages that don't already exist locally
            - Do NOT modify anything outside of dependency sections
            - Do NOT change the Go module path
            - If there are zero version differences, do not create a PR
          claude_args: |
            --model claude-haiku-4-5-20251001
            --max-turns 15
            --allowedTools Read,Write,Edit,Bash(npm install),Bash(cd backend && go mod tidy),Bash(gh pr list:*),Bash(git:*)

      - name: Update sync tracker
        if: steps.context.outputs.has_new_commits == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST_SHA="${{ steps.context.outputs.latest_sha }}"
          TRACKER_FILE=".github/last-sync-commit"

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          # Set authenticated remote URL
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          git stash --include-untracked || true
          git checkout master
          git pull origin master

          echo "$LATEST_SHA" > "$TRACKER_FILE"
          git add "$TRACKER_FILE"

          if git diff --cached --quiet; then
            echo "Tracker file unchanged"
          else
            git commit -m "chore: update dependency sync tracker to ${LATEST_SHA:0:7}"
            git push origin master
            echo "Updated tracker to $LATEST_SHA"
          fi
